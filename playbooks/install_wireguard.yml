---
- name: Install WireGuard and WireGuard UI on Link
  hosts: link
  become: true
  vars_files:
    - homelab_vault.yml  # Make sure this path matches your actual vault file location

  tasks:
    - name: Ensure UFW is installed
      ansible.builtin.package:
        name: ufw
        state: present

    - name: Install WireGuard
      ansible.builtin.package:
        name: wireguard
        state: present

    - name: Install Docker
      ansible.builtin.package:
        name: docker.io
        state: latest

    - name: Ensure Docker Service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Install Docker Compose using apt
      ansible.builtin.package:
        name: docker-compose
        state: latest
      when: ansible_facts['os_family'] == "Debian"

    - name: Deploy WireGuard UI
      ansible.builtin.docker_container:
        name: wireguard-ui
        image: ngoduykhanh/wireguard-ui:latest
        state: started
        published_ports:
          - "51822:5000"
        volumes:
          - "/etc/wireguard:/etc/wireguard"
        restart_policy: always
        env:
          WGUI_USERNAME: "mahdi"
          WGUI_PASSWORD: "{{ wg_ui_password }}"  # This variable is expected to be defined in your vault file
          WGUI_SERVER_INTERFACE_ADDRESSES: "10.252.1.0/24"
          WGUI_FIREWALL_MARK: "0xca6c" # 51821
          WGUI_ENDPOINT_ADDRESS: "morningcoffee.ddns.net"
 
    - name: Open ports for WireGuard and WireGuard UI
      ansible.builtin.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
      loop:
        - { port: 51821, proto: udp }  # WireGuard typically uses UDP
        - { port: 51822, proto: tcp }  # WireGuard UI uses TCP for web interface access

    - name: Allow forwarded traffic from WireGuard clients
      ansible.builtin.iptables:
        chain: FORWARD
        in_interface: wg0
        source: 10.252.1.0/24
        jump: ACCEPT

    - name: Allow forwarded traffic to WireGuard clients (related, established)
      ansible.builtin.iptables:
        chain: FORWARD
        out_interface: wg0
        destination: 10.252.1.0/24
        match: state
        state: RELATED,ESTABLISHED
        jump: ACCEPT

    - name: Install iptables-persistent
      ansible.builtin.package:
        name: iptables-persistent
        state: present

    - name: Save iptables rules
      ansible.builtin.command:
        cmd: "/bin/sh -c 'iptables-save > /etc/iptables/rules.v4'"
      args:
        creates: /etc/iptables/rules.v4


  handlers:
  - name: Restart WireGuard UI
    ansible.builtin.docker_container:
      name: wireguard-ui
      state: restarted

- name: Ensure user has Docker daemon access
  hosts: link
  become: true
  tasks:
    - name: Add user to docker group
      ansible.builtin.user:
        name: mahdi
        groups: docker
        append: yes
      notify: Restart Docker Service

    - name: Restart Docker Service
      ansible.builtin.service:
        name: docker
        state: restarted

